const request   = require('request');
const config= require('../config');
const utils=require('../utils/utils-functions');
const {ProductModel}= require('../utils/models/productModel');

/**
 * makes a get request to get the products for the subcategory
 * in case of error calls reject with the error
 * checks if the is iterable
 * for each object calls the function getImgPath to get the path to the medium image
 * calls resolve with the final array of products
 * @param subcategoryID       the id for the requested subcategory
 * @param page
 * @param baseURL
 * @param secretKey
 * @returns {Promise<unknown>}
 */
exports.getProductsForSubcategory=  (subcategoryID,page, baseURL=config.baseURL, secretKey=config.secretKEY) =>{
    return new Promise((resolve, reject)=> {
        request({
                url: baseURL+'products/product_search?primary_category_id='+subcategoryID+'&secretKey='+secretKey+'&page='+page,
                method: 'GET'
            },
            function (error, response) {
                if (error) {
                    reject({error:error});
                } else {
                    let products=JSON.parse(response.body);
                    if(products.error!==undefined){
                        if('Product Not Found'===products.error)
                            resolve([]);
                        reject({error:products.error});
                    }
                    else {
                        if (utils.isIterable(products))
                            products.forEach(function (item, index) {
                                item.img_path = utils.getImgPath(item, index,'medium');
                            });
                        resolve(products);
                    }
                }
            });
    });

}


/**
 * makes a get request to get a product by it s id
 * in case of error calls reject with the error
 * calls the getImgPath with the large parameter to get the large image path for the product
 * calls resolve with the requested product
 * @param ID                 the id of the requested product
 * @param type
 * @param baseURL
 * @param secretKey
 * @returns {Promise<unknown>}
 */
exports.getProductByID =  (ID, type=1, baseURL=config.baseURL, secretKey=config.secretKEY) =>{
    return new Promise((resolve, reject)=> {
        request({
                url:baseURL+'products/product_search?id='+ID+'&secretKey='+secretKey,
                method: 'GET'
            },
            function (error, response) {
                if (error) {
                    reject({error:error});
                } else {
                    let product=JSON.parse(response.body);
                    if(product.error!==undefined){
                        reject({error:product.error});
                    }
                    else{
                        if(type===0)
                            resolve(product[0])
                        else
                            resolve(new ProductModel(product[0]));
                    }
                }
            });
    });
}
